<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog | PasPages Nebula</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    :root { 
      --nebula-primary: #0891b2; 
      --nebula-glow: rgba(8, 145, 178, 0.15);
    }
    [x-cloak] { display: none !important; }
    .dropdown:hover .dropdown-menu { display: block; }
    /* DNA Nebula Elevation */
    .nebula-card { 
      background: #ffffff;
      border: 1px solid rgba(0,0,0,0.03);
      box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .nebula-card:hover { 
      transform: translateY(-8px);
      box-shadow: 0 20px 50px -12px var(--nebula-glow);
      border-color: var(--nebula-primary);
    }
    .nebula-text-glow { text-shadow: 0 0 10px var(--nebula-glow); }
  </style>
  <script>
    tailwind.config = { 
      theme: { 
        extend: { 
          colors: { primary: { 600: '#0891b2' } } 
        } 
      } 
    }
  </script>
</head>

<body class="bg-[#fcfcfc] text-gray-900 min-h-screen flex flex-col" x-data="blogIndex()">

  <header class="bg-white/80 backdrop-blur-md shadow-sm border-b border-gray-100 sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center max-w-7xl">
        <a href="/" class="font-black text-2xl text-primary-600 flex items-center gap-2 tracking-tighter nebula-text-glow">
            <div class="w-10 h-10 bg-primary-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-cyan-500/30">
                <i class="fas fa-bolt text-sm"></i>
            </div>
            <span>PasPages</span>
        </a>

        <nav class="hidden md:flex gap-1 items-center">
            <template x-for="item in menuTree" :key="item.id">
                <div class="relative dropdown">
                    <a :href="item.url" 
                       class="px-5 py-2 text-[11px] font-black uppercase tracking-[0.15em] text-gray-400 hover:text-primary-600 transition-all flex items-center gap-2 group"
                       :class="window.location.pathname === item.url ? 'text-primary-600' : ''">
                       <span x-text="item.title"></span>
                       <i x-show="item.children.length" class="fas fa-chevron-down text-[8px] group-hover:rotate-180 transition-transform"></i>
                    </a>
                    
                    <template x-if="item.children.length">
                        <div class="dropdown-menu hidden absolute top-full left-0 w-60 bg-white shadow-2xl border border-gray-50 rounded-b-[1.5rem] overflow-hidden py-3 z-50">
                            <template x-for="child in item.children" :key="child.id">
                                <a :href="child.url" class="block px-8 py-3 text-[10px] font-black uppercase tracking-widest text-gray-400 hover:bg-primary-600 hover:text-white transition-all" x-text="child.title"></a>
                            </template>
                        </div>
                    </template>
                </div>
            </template>
        </nav>
        <button class="md:hidden text-gray-400 p-2"><i class="fas fa-bars text-xl"></i></button>
    </div>
  </header>

  <div class="bg-gray-100/30 border-b border-gray-200 py-4">
    <div class="container mx-auto px-4 max-w-7xl">
        <nav class="flex items-center gap-3 text-[10px] uppercase font-black tracking-[0.2em] text-gray-300">
            <a href="/" class="hover:text-primary-600 transition-colors">Home</a>
            <i class="fas fa-chevron-right text-[7px] opacity-20"></i>
            <a href="/blog" class="transition-colors" :class="!currentCategory && !search ? 'text-primary-600' : 'hover:text-primary-600'">Blog Feed</a>
            <template x-if="currentCategory">
                <span class="flex items-center gap-3">
                    <i class="fas fa-chevron-right text-[7px] opacity-20"></i>
                    <span class="text-primary-600" x-text="currentCategory"></span>
                </span>
            </template>
            <template x-if="search">
                <span class="flex items-center gap-3">
                    <i class="fas fa-chevron-right text-[7px] opacity-20"></i>
                    <span class="text-primary-600" x-text="'Searching: ' + search"></span>
                </span>
            </template>
        </nav>
    </div>
  </div>

  <div class="container mx-auto p-6 md:p-12 max-w-7xl flex-grow">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-12">
        
        <main class="lg:col-span-3">
            <div class="flex items-center justify-between mb-12 border-l-4 border-primary-600 pl-6">
                <div>
                    <h1 class="text-3xl font-black text-gray-900 uppercase tracking-tighter" x-text="search ? 'Search Results' : (currentCategory ? 'Browsing ' + currentCategory : 'The Nebula Feed')"></h1>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.3em] mt-2" x-text="posts.length + ' Articles Discovered'"></p>
                </div>
                <button x-show="search || currentCategory" @click="resetFilters()" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-red-500 hover:text-white transition-all">
                    Reset Filter
                </button>
            </div>

            <div x-show="loading" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <template x-for="i in 4">
                    <div class="h-80 bg-gray-100 rounded-[2rem] animate-pulse"></div>
                </template>
            </div>

            <div x-show="!loading" x-cloak class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <template x-for="post in posts" :key="post.id">
                    <a :href="'/post/' + post.slug" class="nebula-card group rounded-[2.5rem] flex flex-col h-full overflow-hidden">
                        <div class="aspect-video relative overflow-hidden bg-gray-100">
                            <img :src="post.thumbnail_url || 'https://via.placeholder.com/800x450'" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
                            <span class="absolute top-6 left-6 bg-white/90 backdrop-blur-sm text-gray-900 text-[9px] font-black uppercase px-4 py-2 rounded-xl shadow-sm" x-text="formatDate(post.created_at)"></span>
                        </div>
                        
                        <div class="p-8 flex-1 flex flex-col">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-[9px] uppercase font-black tracking-[0.2em] text-primary-600 bg-cyan-50 px-3 py-1.5 rounded-lg" x-text="post.category_name || 'Uncategorized'"></span>
                            </div>
                            <h2 class="text-2xl font-black text-gray-800 mb-4 leading-tight group-hover:text-primary-600 transition-colors" x-text="post.title"></h2>
                            <p class="text-sm text-gray-400 line-clamp-3 mb-8 leading-relaxed" x-text="post.excerpt || 'Dive into the details of this article...'"></p>
                            
                            <div class="mt-auto pt-6 border-t border-gray-50 flex items-center justify-between">
                                <div class="text-[10px] font-black text-gray-300 uppercase tracking-widest">
                                    <i class="far fa-eye mr-2 text-primary-600"></i> <span x-text="post.views"></span> Views
                                </div>
                                <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-primary-600 group-hover:bg-primary-600 group-hover:text-white transition-all">
                                    <i class="fas fa-arrow-right text-xs"></i>
                                </div>
                            </div>
                        </div>
                    </a>
                </template>
            </div>

            <div x-show="!loading && posts.length === 0" x-cloak class="text-center py-32 bg-white rounded-[3rem] border-2 border-dashed border-gray-100">
                <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-6 text-gray-200">
                    <i class="fas fa-search text-3xl"></i>
                </div>
                <h3 class="font-black text-gray-400 uppercase tracking-widest">No articles found</h3>
                <p class="text-xs text-gray-300 mt-2">Try different keywords or clear your filters.</p>
            </div>
        </main>

        <aside class="lg:col-span-1 space-y-10">
            <template x-for="widget in widgets" :key="widget.id">
                <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm transition-all hover:shadow-xl">
                    <h3 class="font-black text-gray-900 mb-8 border-b border-gray-50 pb-5 uppercase tracking-[0.3em] text-[11px] flex items-center justify-between">
                        <span x-text="widget.title"></span>
                        <span class="w-2 h-2 bg-primary-600 rounded-full"></span>
                    </h3>
                    
                    <div x-show="widget.type === 'search_bar'" class="relative">
                        <input type="text" x-model="search" @keyup.enter="fetchPosts()" placeholder="Hit Enter to search..." class="w-full bg-gray-50 border border-transparent rounded-2xl px-6 py-4 text-xs font-bold focus:bg-white focus:ring-2 focus:ring-primary-600 outline-none transition-all">
                        <i class="fas fa-search absolute right-5 top-4.5 text-gray-300"></i>
                    </div>

                    <div x-show="widget.type === 'recent_posts'" class="space-y-6">
                        <template x-for="rp in posts.slice(0, 5)" :key="rp.id">
                            <a :href="'/post/' + rp.slug" class="flex gap-4 items-center group/item">
                                <div class="w-14 h-14 rounded-2xl bg-gray-100 shrink-0 overflow-hidden shadow-inner">
                                    <img :src="rp.thumbnail_url" class="w-full h-full object-cover grayscale opacity-40 group-hover/item:opacity-100 group-hover/item:grayscale-0 transition-all">
                                </div>
                                <div class="overflow-hidden">
                                    <h4 class="text-[11px] font-black text-gray-700 leading-tight truncate group-hover/item:text-primary-600 transition" x-text="rp.title"></h4>
                                    <p class="text-[9px] text-gray-300 font-bold uppercase mt-1" x-text="formatDate(rp.created_at)"></p>
                                </div>
                            </a>
                        </template>
                    </div>

                    <div x-show="widget.type === 'categories'" class="space-y-3">
                        <template x-for="cat in sidebarData.categories" :key="cat.slug">
                            <a :href="'/blog/category/' + cat.slug" class="flex justify-between items-center text-[10px] font-black text-gray-400 hover:text-primary-600 uppercase tracking-widest border-b border-gray-50 pb-3 transition-colors">
                                <span x-text="cat.name"></span>
                                <span class="bg-gray-50 text-gray-400 px-3 py-1 rounded-lg group-hover:bg-primary-600 group-hover:text-white transition-all" x-text="cat.count"></span>
                            </a>
                        </template>
                    </div>

                    <div x-show="widget.type === 'html'" class="text-xs text-gray-500 leading-relaxed overflow-hidden" x-html="widget.content"></div>
                </div>
            </template>
        </aside>
    </div>
  </div>

  <footer class="py-16 border-t border-gray-100 text-center">
      <div class="container mx-auto px-4">
          <p class="text-[10px] font-black uppercase tracking-[0.5em] text-gray-300">&copy; 2026 PasPages core &bull; nebula design engine</p>
      </div>
  </footer>

  <script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('blogIndex', () => ({
            posts: [], 
            menus: [], 
            widgets: [], 
            sidebarData: { categories: [] }, 
            loading: true, 
            search: '', 
            currentCategory: '',

            get menuTree() {
                const roots = this.menus.filter(m => !m.parent_id);
                return roots.map(root => ({ ...root, children: this.menus.filter(m => m.parent_id == root.id) }));
            },

            async init() {
                // Parse Category from Path
                const pathParts = window.location.pathname.split('/').filter(p => p);
                if (window.location.pathname.includes('/category/')) {
                    this.currentCategory = decodeURIComponent(pathParts.pop());
                }

                await Promise.all([this.fetchPosts(), this.fetchMenus(), this.fetchWidgets()]);
                this.loading = false;
            },

            async fetchPosts() {
                this.loading = true;
                const params = new URLSearchParams();
                if (this.currentCategory) params.append('category', this.currentCategory);
                if (this.search) params.append('search', this.search);
                
                try {
                    const res = await fetch('/api/blog?' + params.toString());
                    if(res.ok) this.posts = await res.json();
                } catch (e) { console.error(e); }
                finally { this.loading = false; }
            },

            async fetchMenus() {
                const res = await fetch('/api/blog/menus');
                if(res.ok) this.menus = await res.json();
            },

            async fetchWidgets() {
                const [wRes, sRes] = await Promise.all([
                    fetch('/api/blog/widgets'),
                    fetch('/api/blog/sidebar')
                ]);
                if(wRes.ok) this.widgets = await wRes.json();
                if(sRes.ok) this.sidebarData = await sRes.json();
            },

            resetFilters() {
                window.location.href = '/blog';
            },

            formatDate(d) {
                if(!d) return '';
                return new Date(d).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
            }
        }))
    })
  </script>
</body>
</html>